---
import { getCollection } from 'astro:content'
import MainLayout from '@/layouts/MainLayout.astro'

// 读取博客集合，按时间倒序
const posts = (await getCollection('archives')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
)

// 按年份分组
const groups = posts.reduce(
    (acc: Record<string, typeof posts>, post) => {
        const year = new Date(post.data.pubDate).getFullYear().toString()
        acc[year] ||= [] as any
        acc[year].push(post)
        return acc
    },
    {} as Record<string, typeof posts>
)

const years = Object.keys(groups).sort((a, b) => Number(b) - Number(a))

// 格式化
const formatDate = (date: Date | string) => {
    const d = new Date(date)
    const mm = String(d.getMonth() + 1).padStart(2, '0')
    const dd = String(d.getDate()).padStart(2, '0')
    return `${mm}-${dd}`
}
---

<MainLayout title="咕咕归档 - 云萧的咕咕屋" description="浏览所有博客文章">
    <div class="r-content">
        <div class="r-header">
            <div class="r-title">咕咕归档</div>
            <div class="r-subtitle">共 {posts.length} 篇文章</div>
        </div>

        <div class="r-timeline">
            {
                years.map((year) => (
                    <div id={`y-${year}`}>
                        <h2 class="r-catalog">{year}</h2>
                        <div class="r-list">
                            {groups[year].map((post) => (
                                <div class="r-item">
                                    <div class="r-date">
                                        {formatDate(post.data.pubDate)}
                                    </div>
                                    <a class="r-article" href={`/archives/${post.slug}.html`}>
                                        {post.data.title}
                                    </a>
                                </div>
                            ))}
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</MainLayout>

<style lang="less">
    @import url('@/styles/variables.less');

    .r-timeline {
        margin-bottom: 24px;
        display: flex;
        flex-direction: column;

        .r-catalog {
            color: @color-theme;
            margin: 12px 0;
        }

        .r-list {
            list-style: none;
            position: relative;
            margin: 0;
            padding: 0;
            min-height: 12px;

            .r-item {
                position: relative;
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 0;
                margin: 6px 0;
            }

            .r-date {
                width: 56px;
                flex: 0 0 auto;
                text-align: right;
                color: @color-secondary;
            }

            .r-article {
                flex: 1;
                padding-left: 24px;
                font-size: 18px;
                color: @color-text;
                text-decoration: none;
                transition: color 0.15s ease;
            }

            .r-article:hover {
                color: @color-theme;
            }
        }
    }

    // 时间轴
    .r-list::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: calc(56px + 18px); // 56px 日期宽度 + 18px 间距
        width: 2px;
        background: @color-border;
    }

    // 时间点
    .r-item::before {
        content: '';
        position: absolute;
        top: 50%;
        left: calc(56px + 18px);
        width: 10px;
        height: 10px;
        background: @color-theme;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }
</style>
