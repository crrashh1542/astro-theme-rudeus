---
import { Icon } from 'astro-icon/components'
---

<header>
    <div class="r-container">
        <div class="r-menu">
            <a href="/" class="r-index">云萧的咕咕屋</a>
            <span></span>
            <a href="/friends">友人帐</a>
            <a href="/about">关于</a>
            <a href="/archives">归档</a>
        </div>
        <span class="r-search" data-open="false">
            <Icon name="mdi:search" width={24} height={24} class="r-search-btn" />
            <input class="r-search-input" type="text" placeholder="搜索...">
        </span>
    </div>
</header>

<style lang="less">
    @layout-search-spacing: 6px;
    @layout-search-width: 200px;

    @import url('@/styles/variables.less');
    header {
        background-color: rgba(255, 255, 255, .8);
        backdrop-filter: blur(5px);
        padding: calc(18px - @layout-search-spacing) 0;
        position: sticky;
        top: 0;
        z-index: 100;

        a {
            transition: all @anim-duration ease;
        }
        a:hover {
            color: @color-theme;
        }
    }
    .r-container {
        display: flex;
        justify-content: space-between;
        align-items: center;

        .r-menu {
            display: flex;
            flex-direction: row;
            gap: 2.5em;
            font-weight: 500;
            font-size: 15px;
            align-items: center;

            .r-index {
                font-size: 20px;
                font-weight: 600;
            }
        }

        // 初始搜索框
        .r-search {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            position: relative;
            transition: all @anim-duration ease;
            .r-search-btn {
                background: transparent;
                border: 0;
                margin: @layout-search-spacing 0;
                cursor: pointer;
            }
            .r-search-input {
                width: 0;
                opacity: 0;
                border: 0;
                background: transparent;
                outline: none;
                transition: all @anim-duration ease;
                font-size: 14px;
            }
        }
        // 展开的搜索框
        .r-search[data-open='true'] {
            background-color: #eee;
            border-radius: 8px;
            .r-search-input {
                width: @layout-search-width;
                opacity: 1;
                padding: @layout-search-spacing;
            }
        }
    }
</style>

<script>
    let searchWrap: HTMLElement | null = null
    let searchBtn: HTMLElement | null = null
    let searchInput: HTMLInputElement | null = null

    const setOpen = (open: boolean) => {
        if (!searchWrap) return
        searchWrap.setAttribute('data-open', open ? 'true' : 'false')
        if (open && searchInput) searchInput.focus()
        if (!open && searchInput) searchInput.blur()
    }

    const emitSearch = (query: string) => {
        window.dispatchEvent(new CustomEvent('r-search', { detail: { query } }))
    }

    const syncQueryFromUrl = () => {
        const params = new URLSearchParams(window.location.search)
        const query = params.get('q') || ''
        if (searchInput) searchInput.value = query
        if (query) setOpen(true)
    }

    const onBtnClick = (event: Event) => {
        event.stopPropagation()
        const isOpen = searchWrap?.getAttribute('data-open') == 'true'
        setOpen(!isOpen)
    }

    const onInput = (event: Event) => {
        const target = event.target as HTMLInputElement | null
        const query = target?.value?.trim() ?? ''
        emitSearch(query)

        if (window.location.pathname.startsWith('/search')) {
            const url = new URL(window.location.href)
            if (query) {
                url.searchParams.set('q', query)
            } else {
                url.searchParams.delete('q')
            }
            window.history.replaceState({}, '', url.toString())
        }
    }

    const onKeydown = (event: KeyboardEvent) => {
        if (event.key !== 'Enter') return
        const query = (event.target as HTMLInputElement | null)?.value?.trim() ?? ''
        if (!query) return
        if (!window.location.pathname.startsWith('/search')) {
            window.location.href = `/search?q=${encodeURIComponent(query)}`
        }
    }

    const initSearch = () => {
        searchWrap = document.querySelector('.r-search')
        searchBtn = document.querySelector('.r-search-btn')
        searchInput = document.querySelector('.r-search-input')

        if (!searchWrap || !searchBtn || !searchInput) return

        if (!searchBtn.dataset.bound) {
            searchBtn.addEventListener('click', onBtnClick)
            searchBtn.dataset.bound = 'true'
        }

        if (!searchInput.dataset.bound) {
            searchInput.addEventListener('input', onInput)
            searchInput.addEventListener('keydown', onKeydown)
            searchInput.dataset.bound = 'true'
        }

        syncQueryFromUrl()
    }

    if (!(window as any).__rSearchDocBound) {
        document.addEventListener('click', (event) => {
            if (!searchWrap) return
            if (searchWrap.contains(event.target as Node)) return
            setOpen(false)
        })
        ;(window as any).__rSearchDocBound = true
    }

    // 处理跨页后搜索框打不开
    document.addEventListener('astro:page-load', initSearch)
    document.addEventListener('astro:after-swap', initSearch)
</script>
